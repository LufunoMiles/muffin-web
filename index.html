<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sweet Delights Muffin Shop</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #ff6b6b;
            --primary-dark: #ff5252;
            --secondary-color: #4ecdc4;
            --accent-color: #ffe66d;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --background: #fefefe;
            --surface: #ffffff;
            --border: #e8ecef;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.12);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
        }

        .navbar {
            background: var(--surface);
            backdrop-filter: blur(20px);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo::before {
            content: 'üßÅ';
            font-size: 2rem;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: var(--transition);
            position: relative;
        }

        .nav-links a:hover {
            color: var(--primary-color);
            background: rgba(255, 107, 107, 0.1);
            transform: translateY(-2px);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hero {
            text-align: center;
            padding: 4rem 0;
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-family: 'Playfair Display', serif;
            font-size: 3.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .auth-form {
            max-width: 450px;
            margin: 2rem auto;
            padding: 3rem;
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .auth-form h2 {
            font-family: 'Playfair Display', serif;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--primary-color);
            font-size: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--background);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        .form-group label {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: var(--text-secondary);
            transition: var(--transition);
            pointer-events: none;
        }

        .form-group input:focus + label,
        .form-group input:not(:placeholder-shown) + label {
            top: -0.5rem;
            left: 0.5rem;
            font-size: 0.8rem;
            color: var(--primary-color);
            background: var(--surface);
            padding: 0 0.5rem;
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .product-card {
            background: var(--surface);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .product-card:hover::before {
            transform: scaleX(1);
        }

        .product-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-hover);
        }

        .product-image {
            width: 100%;
            height: 220px;
            object-fit: cover;
            transition: var(--transition);
        }

        .product-card:hover .product-image {
            transform: scale(1.05);
        }

        .product-info {
            padding: 1.5rem;
        }

        .product-name {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .product-description {
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .product-price {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .product-stock {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .product-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .quantity-input {
            width: 70px;
            padding: 0.5rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
        }

        .cart-item {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding: 1.5rem;
            background: var(--surface);
            margin-bottom: 1rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .cart-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-hover);
        }

        .cart-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: var(--border-radius);
        }

        .cart-item-details {
            flex: 1;
        }

        .cart-item-details h4 {
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .order-card {
            background: var(--surface);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            transition: var(--transition);
        }

        .order-card:hover {
            box-shadow: var(--shadow-hover);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .order-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pending { 
            background: linear-gradient(135deg, #fff3cd, #ffeaa7); 
            color: #856404; 
        }
        .status-confirmed { 
            background: linear-gradient(135deg, #d1ecf1, #74b9ff); 
            color: #0c5460; 
        }
        .status-shipped { 
            background: linear-gradient(135deg, #d4edda, #00b894); 
            color: #155724; 
        }
        .status-delivered { 
            background: linear-gradient(135deg, #d1e7dd, #00cec9); 
            color: #0f5132; 
        }

        .admin-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: var(--surface);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3);
        }

        .admin-tab-content {
            display: none;
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .admin-tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        #add-product-form input,
        #add-product-form textarea {
            width: 100%;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--border);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--background);
        }

        #add-product-form input:focus,
        #add-product-form textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.1);
        }

        #add-product-form textarea {
            height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: var(--transition);
            box-shadow: var(--shadow-hover);
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #00b894, #00cec9);
        }

        .notification.error {
            background: linear-gradient(135deg, #e17055, #d63031);
        }

        .notification.info {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
        }

        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .section-header h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .section-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--surface);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .empty-state p {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }

            .hero h2 {
                font-size: 2.5rem;
            }

            .cart-item {
                flex-direction: column;
                text-align: center;
            }

            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .admin-tabs {
                flex-direction: column;
            }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .cart-total {
            background: var(--surface);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            text-align: center;
            margin-top: 2rem;
        }

        .cart-total h3 {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="logo"></h1>
            <div class="nav-links">
                <a href="#" onclick="showSection('home')">Home</a>
                <a href="#" onclick="showSection('products')">Products</a>
                <a href="#" onclick="showSection('cart')">Cart</a>
                <a href="#" onclick="showSection('orders')">My Orders</a>
                <div id="auth-links">
                    <a href="#" onclick="showSection('login')">Login</a>
                    <a href="#" onclick="showSection('register')">Register</a>
                </div>
                <div id="admin-links" style="display: none;">
                    <a href="#" onclick="showSection('admin')">Admin</a>
                </div>
                <div id="user-info" style="display: none;">
                    <span id="user-name"></span>
                    <a href="#" onclick="logout()">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <main class="container">
    
        <section id="home" class="section active">
            <div class="hero">
                <h2>Freshly Baked Delights</h2>
                <p>Discover our artisanal collection of muffins, made with love and the finest ingredients. Each bite is a moment of pure bliss.</p>
                <button onclick="showSection('products')" class="btn btn-primary">
                    Explore Our Menu ‚ú®
                </button>
            </div>
        </section>

         
        <!-- Login Section -->
<section id="login" class="section">
    <div class="auth-form">
        <h2>Welcome Back</h2>
        <!-- ADD THIS LINE -->
        <p style="text-align: center; color: var(--text-secondary); margin-bottom: 2rem; font-size: 0.9rem;">
            Admin access: admin@muffinshop.com
        </p>
        <form id="login-form">
            <div class="form-group">
                <input type="email" id="login-email" placeholder=" " required>
                <label>Email Address</label>
            </div>
            <div class="form-group">
                <input type="password" id="login-password" placeholder=" " required>
                <label>Password</label>
            </div>
            <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                Sign In
            </button>
        </form>
        <p style="text-align: center; color: var(--text-secondary);">
            Don't have an account? 
            <a href="#" onclick="showSection('register')" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">
                Create one here
            </a>
        </p>
    </div>
</section>

         
        <section id="register" class="section">
            <div class="auth-form">
                <h2>Join Our Family</h2>
                <form id="register-form">
                    <div class="form-group">
                        <input type="text" id="register-name" placeholder=" " required>
                        <label>Full Name</label>
                    </div>
                    <div class="form-group">
                        <input type="email" id="register-email" placeholder=" " required>
                        <label>Email Address</label>
                    </div>
                    <div class="form-group">
                        <input type="password" id="register-password" placeholder=" " required>
                        <label>Password</label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">
                        Create Account
                    </button>
                </form>
                <p style="text-align: center; color: var(--text-secondary);">
                    Already have an account? 
                    <a href="#" onclick="showSection('login')" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">
                        Sign in here
                    </a>
                </p>
            </div>
        </section>

     
        <section id="products" class="section">
            <div class="section-header">
                <h2>Our Delicious Muffins</h2>
                <p>Handcrafted with premium ingredients and baked fresh daily</p>
            </div>
            <div id="products-grid" class="products-grid">
                 Products will be loaded here 
            </div>
        </section>

        <section id="cart" class="section">
            <div class="section-header">
                <h2>Your Shopping Cart</h2>
                <p>Review your selected items before checkout</p>
            </div>
            <div id="cart-items">
                  
            </div>
            <div id="cart-total" class="cart-total" style="display: none;">
                <h3>Total: $<span id="total-amount">0.00</span></h3>
                <button onclick="checkout()" class="btn btn-primary">
                    Proceed to Checkout üõí
                </button>
            </div>
        </section>

    
        <section id="orders" class="section">
            <div class="section-header">
                <h2>Order History</h2>
                <p>Track your past and current orders</p>
            </div>
            <div id="orders-list">
                 Orders will be loaded here 
            </div>
        </section>

      <!-- Admin Section -->
<section id="admin" class="section">
    <div class="section-header">
        <h2>Admin Dashboard</h2>
        <p>Manage products and orders</p>
    </div>
    
    <div class="admin-tabs">
        <button class="tab-btn active" onclick="openAdminTab('add-product')">Add Product</button>
        <button class="tab-btn" onclick="openAdminTab('manage-orders')">Manage Orders</button>
        <button class="tab-btn" onclick="openAdminTab('manage-products')">Manage Products</button>
    </div>

    <div id="add-product" class="admin-tab-content active">
        <form id="add-product-form" enctype="multipart/form-data">
            <input type="text" name="name" placeholder="Product Name" required>
            <textarea name="description" placeholder="Product Description"></textarea>
            <input type="number" name="price" step="0.01" placeholder="Price ($)" required>
            <input type="number" name="stock" placeholder="Stock Quantity" required>
            <input type="file" name="image" accept="image/*" style="margin-bottom: 2rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                Add Product üßÅ
            </button>
        </form>
    </div>

    <div id="manage-orders" class="admin-tab-content">
        <div id="admin-orders-list">
            <!-- Admin orders will be loaded here -->
        </div>
    </div>

    <div id="manage-products" class="admin-tab-content">
        <div id="admin-products-list">
            <!-- Products management will be loaded here -->
        </div>
    </div>
</section> 
      
    </main>

    <div id="notification" class="notification"></div>

    <script>
  const API_BASE = '/api';

class MuffinShop {
    constructor() {
        this.currentUser = null;
        this.init();
    }

    async init() {
        await this.checkAuth();
        this.setupEventListeners();
        this.loadProducts();
    }

    setupEventListeners() {
        // Auth forms
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const addProductForm = document.getElementById('add-product-form');
        
        if (loginForm) {
            loginForm.addEventListener('submit', (e) => this.handleLogin(e));
        }
        if (registerForm) {
            registerForm.addEventListener('submit', (e) => this.handleRegister(e));
        }
        if (addProductForm) {
            addProductForm.addEventListener('submit', (e) => this.handleAddProduct(e));
        }
    }

    async checkAuth() {
        try {
            const response = await fetch(`${API_BASE}/auth?action=check`, {
                credentials: 'include'
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.loggedIn) {
                this.currentUser = data.user;
                this.updateUIForUser();
            } else {
                this.updateUIForGuest();
            }
        } catch (error) {
            console.error('Auth check failed:', error);
            this.updateUIForGuest();
        }
    }

    updateUIForUser() {
        const authLinks = document.getElementById('auth-links');
        const userInfo = document.getElementById('user-info');
        const adminLinks = document.getElementById('admin-links');
        const userName = document.getElementById('user-name');
        
        if (authLinks) authLinks.style.display = 'none';
        if (userInfo) userInfo.style.display = 'flex';
        if (userName) userName.textContent = `Hello, ${this.currentUser.name}`;
        
        if (adminLinks) {
            if (this.currentUser.role === 'admin') {
                adminLinks.style.display = 'block';
                // Load admin data if on admin page
                if (document.getElementById('admin')?.classList.contains('active')) {
                    this.loadAdminOrders();
                    this.loadAdminProducts();
                }
            } else {
                adminLinks.style.display = 'none';
            }
        }
        
        // Load user-specific data
        this.loadCart();
        this.loadOrders();
    }

    updateUIForGuest() {
        const authLinks = document.getElementById('auth-links');
        const userInfo = document.getElementById('user-info');
        const adminLinks = document.getElementById('admin-links');
        
        if (authLinks) authLinks.style.display = 'flex';
        if (userInfo) userInfo.style.display = 'none';
        if (adminLinks) adminLinks.style.display = 'none';
    }

    async handleLogin(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Signing In...';
        submitBtn.disabled = true;

        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            const response = await fetch(`${API_BASE}/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'login',
                    email: email,
                    password: password
                }),
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                if (data.user.role === 'admin') {
                    this.showNotification('Welcome back, Administrator! üëë', 'success');
                } else {
                    this.showNotification(`Welcome back, ${data.user.name}! üéâ`, 'success');
                }
                this.currentUser = data.user;
                this.updateUIForUser();
                showSection('home');
                e.target.reset();
            } else {
                this.showNotification(data.error || 'Login failed', 'error');
            }
        } catch (error) {
            console.error('Login error:', error);
            this.showNotification('Connection error. Please try again.', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    async handleRegister(e) {
        e.preventDefault();
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Creating Account...';
        submitBtn.disabled = true;

        const formData = new FormData(e.target);
        const userData = {
            action: 'register',
            name: formData.get('name'),
            email: formData.get('email'),
            password: formData.get('password')
        };

        try {
            const response = await fetch(`${API_BASE}/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData),
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                this.showNotification('Account created successfully! üéâ', 'success');
                this.currentUser = data.user;
                this.updateUIForUser();
                showSection('home');
                e.target.reset();
            } else {
                this.showNotification(data.error || 'Registration failed', 'error');
            }
        } catch (error) {
            console.error('Registration error:', error);
            this.showNotification('Connection error. Please try again.', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    async logout() {
        try {
            await fetch(`${API_BASE}/auth`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'logout' }),
                credentials: 'include'
            });
            
            this.currentUser = null;
            this.updateUIForGuest();
            this.showNotification('See you soon! üëã', 'info');
            showSection('home');
        } catch (error) {
            console.error('Logout failed:', error);
        }
    }

    async loadProducts() {
        try {
            const response = await fetch(`${API_BASE}/products`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const products = await response.json();
            this.renderProducts(products);
        } catch (error) {
            console.error('Failed to load products:', error);
            this.renderProducts([]);
        }
    }

    renderProducts(products) {
        const grid = document.getElementById('products-grid');
        if (!grid) return;
        
        if (products.length === 0) {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1;">
                    <div class="empty-state-icon">üßÅ</div>
                    <h3>No Products Available</h3>
                    <p>Check back soon for delicious muffins!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = products.map(product => `
            <div class="product-card">
                <img src="${product.image_url || '/placeholder.svg?height=220&width=320'}" alt="${product.name}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
                    <div class="product-stock">üì¶ ${product.stock} available</div>
                    <div class="product-actions">
                        <input type="number" class="quantity-input" value="1" min="1" max="${product.stock}" id="qty-${product.id}">
                        <button onclick="addToCart(${product.id})" class="btn btn-primary" ${product.stock === 0 ? 'disabled' : ''}>
                            ${product.stock === 0 ? 'Out of Stock' : 'Add to Cart'}
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async addToCart(productId) {
        if (!this.currentUser) {
            this.showNotification('Please sign in to add items to your cart üîê', 'error');
            showSection('login');
            return;
        }

        const quantityInput = document.getElementById(`qty-${productId}`);
        if (!quantityInput) {
            this.showNotification('Product not found', 'error');
            return;
        }

        const quantity = parseInt(quantityInput.value);
        if (isNaN(quantity) || quantity < 1) {
            this.showNotification('Please enter a valid quantity', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/cart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'add',
                    product_id: productId,
                    quantity: quantity
                }),
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                this.showNotification('Added to cart! üõí', 'success');
                this.loadCart();
            } else {
                this.showNotification(data.error || 'Failed to add to cart', 'error');
            }
        } catch (error) {
            console.error('Add to cart error:', error);
            this.showNotification('Connection error. Please try again.', 'error');
        }
    }

    async loadCart() {
        if (!this.currentUser) return;

        try {
            const response = await fetch(`${API_BASE}/cart`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'get' }),
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            this.renderCart(data);
        } catch (error) {
            console.error('Failed to load cart:', error);
        }
    }

    renderCart(cartData) {
        const cartItems = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        
        if (!cartItems) return;

        if (!cartData.items || cartData.items.length === 0) {
            cartItems.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <h3>Your Cart is Empty</h3>
                    <p>Add some delicious muffins to get started!</p>
                    <button onclick="showSection('products')" class="btn btn-primary">
                        Browse Products
                    </button>
                </div>
            `;
            if (cartTotal) cartTotal.style.display = 'none';
            return;
        }

        cartItems.innerHTML = cartData.items.map(item => `
            <div class="cart-item">
                <img src="${item.image_url || '/placeholder.svg?height=100&width=100'}" alt="${item.name}" class="cart-item-image">
                <div class="cart-item-details">
                    <h4>${item.name}</h4>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">Quantity: ${item.quantity}</p>
                    <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">$${parseFloat(item.price).toFixed(2)} each</p>
                    <p style="font-weight: 600; color: var(--primary-color);">Total: $${parseFloat(item.item_total).toFixed(2)}</p>
                </div>
            </div>
        `).join('');

        const totalAmount = document.getElementById('total-amount');
        if (totalAmount && cartTotal) {
            totalAmount.textContent = parseFloat(cartData.total).toFixed(2);
            cartTotal.style.display = 'block';
        }
    }

    async checkout() {
        if (!this.currentUser) return;

        const checkoutBtn = document.querySelector('#cart-total button');
        if (!checkoutBtn) return;

        const originalText = checkoutBtn.innerHTML;
        checkoutBtn.innerHTML = '<span class="loading"></span> Processing...';
        checkoutBtn.disabled = true;

        try {
            const response = await fetch(`${API_BASE}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                this.showNotification('Order placed successfully! üéâ', 'success');
                this.loadCart();
                this.loadOrders();
                showSection('orders');
            } else {
                this.showNotification(data.error || 'Checkout failed', 'error');
            }
        } catch (error) {
            console.error('Checkout error:', error);
            this.showNotification('Connection error. Please try again.', 'error');
        } finally {
            checkoutBtn.innerHTML = originalText;
            checkoutBtn.disabled = false;
        }
    }

    async loadOrders() {
        if (!this.currentUser) return;

        try {
            const response = await fetch(`${API_BASE}/orders`, {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const orders = await response.json();
            this.renderOrders(orders);
        } catch (error) {
            console.error('Failed to load orders:', error);
        }
    }

    renderOrders(orders) {
        const ordersList = document.getElementById('orders-list');
        if (!ordersList) return;

        if (!orders || orders.length === 0) {
            ordersList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3>No Orders Yet</h3>
                    <p>Your order history will appear here once you make your first purchase.</p>
                    <button onclick="showSection('products')" class="btn btn-primary">
                        Start Shopping
                    </button>
                </div>
            `;
            return;
        }

        ordersList.innerHTML = orders.map(order => `
            <div class="order-card">
                <div class="order-header">
                    <h3>Order #${order.id}</h3>
                    <span class="order-status status-${order.status}">${order.status}</span>
                </div>
                <p style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem;">
                    Total: $${parseFloat(order.total_price).toFixed(2)}
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    üìÖ ${new Date(order.created_at).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}
                </p>
                <div class="order-items">
                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Items:</h4>
                    ${order.items.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <span>${item.name} <small style="color: var(--text-secondary);">(√ó${item.quantity})</small></span>
                            <span style="font-weight: 600;">$${parseFloat(item.price).toFixed(2)} each</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `).join('');
    }

    async loadAdminOrders() {
        if (!this.currentUser || this.currentUser.role !== 'admin') return;

        try {
            const response = await fetch(`${API_BASE}/admin/orders`, {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const orders = await response.json();
            this.renderAdminOrders(orders);
        } catch (error) {
            console.error('Failed to load admin orders:', error);
        }
    }

    renderAdminOrders(orders) {
        const adminOrdersList = document.getElementById('admin-orders-list');
        if (!adminOrdersList) return;

        if (!orders || orders.length === 0) {
            adminOrdersList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <h3>No Orders</h3>
                    <p>No orders have been placed yet.</p>
                </div>
            `;
            return;
        }

        adminOrdersList.innerHTML = orders.map(order => `
            <div class="order-card">
                <div class="order-header">
                    <h3>Order #${order.id} - ${order.user_name}</h3>
                    <span class="order-status status-${order.status}">${order.status}</span>
                </div>
                <p style="font-size: 1.2rem; font-weight: 600; color: var(--primary-color); margin-bottom: 1rem;">
                    Total: $${parseFloat(order.total_price).toFixed(2)}
                </p>
                <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                    üìÖ ${new Date(order.created_at).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}
                </p>
                <div class="order-items">
                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Items:</h4>
                    ${order.items.map(item => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                            <span>${item.name} <small style="color: var(--text-secondary);">(√ó${item.quantity})</small></span>
                            <span style="font-weight: 600;">$${parseFloat(item.price).toFixed(2)} each</span>
                        </div>
                    `).join('')}
                </div>
                <div class="admin-order-actions" style="margin-top: 1rem;">
                    <button onclick="updateOrderStatus(${order.id})" class="btn btn-secondary">Update Status</button>
                </div>
            </div>
        `).join('');
    }

    async loadAdminProducts() {
        if (!this.currentUser || this.currentUser.role !== 'admin') return;

        try {
            const response = await fetch(`${API_BASE}/admin/products`, {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const products = await response.json();
            this.renderAdminProducts(products);
        } catch (error) {
            console.error('Failed to load admin products:', error);
        }
    }

    renderAdminProducts(products) {
        const adminProductsList = document.getElementById('admin-products-list');
        if (!adminProductsList) return;

        if (!products || products.length === 0) {
            adminProductsList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üßÅ</div>
                    <h3>No Products</h3>
                    <p>No products have been added yet.</p>
                </div>
            `;
            return;
        }

        adminProductsList.innerHTML = products.map(product => `
            <div class="product-card">
                <img src="${product.image_url || '/placeholder.svg?height=220&width=320'}" alt="${product.name}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-description">${product.description}</div>
                    <div class="product-price">$${parseFloat(product.price).toFixed(2)}</div>
                    <div class="product-stock">üì¶ ${product.stock} available</div>
                    <div class="admin-product-actions">
                        <button onclick="editProduct(${product.id})" class="btn btn-secondary">Edit</button>
                        <button onclick="deleteProduct(${product.id})" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        `).join('');
    }

    async handleAddProduct(e) {
        e.preventDefault();
        if (!this.currentUser || this.currentUser.role !== 'admin') return;

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> Adding Product...';
        submitBtn.disabled = true;

        const formData = new FormData(e.target);

        try {
            const response = await fetch(`${API_BASE}/admin`, {
                method: 'POST',
                body: formData,
                credentials: 'include'
            });

            const data = await response.json();

            if (response.ok) {
                this.showNotification('Product added successfully! ‚ú®', 'success');
                e.target.reset();
                this.loadProducts();
                this.loadAdminProducts();
            } else {
                this.showNotification(data.error || 'Failed to add product', 'error');
            }
        } catch (error) {
            console.error('Add product error:', error);
            this.showNotification('Connection error. Please try again.', 'error');
        } finally {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    showNotification(message, type = 'info') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }
}

// Global functions for HTML onclick handlers
function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Load admin data if showing admin section
    if (sectionId === 'admin' && window.app?.currentUser?.role === 'admin') {
        window.app.loadAdminOrders();
        window.app.loadAdminProducts();
    }
}

function addToCart(productId) {
    if (window.app) {
        window.app.addToCart(productId);
    }
}

function checkout() {
    if (window.app) {
        window.app.checkout();
    }
}

function logout() {
    if (window.app) {
        window.app.logout();
    }
}

function openAdminTab(tabName, event) {
    // Hide all tab contents
    document.querySelectorAll('.admin-tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab content and activate button
    const targetTab = document.getElementById(tabName);
    if (targetTab) {
        targetTab.classList.add('active');
    }
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Load appropriate data
    if (tabName === 'manage-orders' && window.app?.currentUser?.role === 'admin') {
        window.app.loadAdminOrders();
    } else if (tabName === 'manage-products' && window.app?.currentUser?.role === 'admin') {
        window.app.loadAdminProducts();
    }
}

function updateOrderStatus(orderId) {
    const newStatus = prompt('Enter new status (pending/confirmed/shipped/delivered):');
    if (newStatus && ['pending', 'confirmed', 'shipped', 'delivered'].includes(newStatus.toLowerCase())) {
        window.app?.showNotification('Order status update functionality coming soon!', 'info');
    }
}

function editProduct(productId) {
    window.app?.showNotification('Product edit functionality coming soon!', 'info');
}

function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        window.app?.showNotification('Product delete functionality coming soon!', 'info');
    }
}

// Initialize the application
const app = new MuffinShop();
window.app = app; // Make app globally accessible
    </script>
</body>
</html>